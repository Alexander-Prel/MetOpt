# Лабораторная работа 4 — Пошаговое управление инвестиционным портфелем

## Общие сведения

**Ф.И.О.:** Прель Александр Сергеевич  \
**Группа:** МЕТОПТ 1.1

---

## 1. Цель работы и постановка задачи

Сформировать оптимальный план покупок/продаж ценных бумаг и депозитов на трёх этапах при неопределённости, используя динамическое программирование и критерий Байеса (максимизация математического ожидания конечного дохода).

### Постановка задачи

На каждом этапе инвестор может покупать/продавать ЦБ1, ЦБ2 и депозиты **только пакетами** (25, 200, 100 д.е. соответственно), не используя кредит. После реализации сценария этапа стоимость активов изменяется по заданным коэффициентам. Требуется найти стратегию управления, максимизирующую **ожидаемый** итоговый капитал.

### Выбранное задание

**Задание 2:** математическая постановка + программная реализация + определение оптимального управления и максимального дохода (критерий Байеса).

---

### Исходные данные

Источник: `Данные для постановки задачи.xlsx`.

**Начальные вложения (на момент до 1‑го этапа):**
- ЦБ1: 100 д.е.
- ЦБ2: 800 д.е.
- Депозиты: 400 д.е.
- Свободные средства: 600 д.е. (в файле не указано, взято из условия)

**Размер «пакета» (1/4 от начальной стоимости):**
- ЦБ1: 25 д.е.
- ЦБ2: 200 д.е.
- Депозиты: 100 д.е.

**Комиссии брокеров (из файла):**
- ЦБ1: 4%
- ЦБ2: 7%
- Депозиты: 5%

**Минимальные остатки (из файла):**
- ЦБ1 ≥ 30 д.е.
- ЦБ2 ≥ 150 д.е.
- Депозиты ≥ 100 д.е.

### Этап 1
| Ситуация | Вероятность | ЦБ1 | ЦБ2 | Деп. |
|---|---:|---:|---:|---:|
| Благоприятная | 0.60 | 1.20 | 1.10 | 1.07 |
| Нейтральная  | 0.30 | 1.05 | 1.02 | 1.03 |
| Негативная   | 0.10 | 0.80 | 0.95 | 1.00 |

### Этап 2
| Ситуация | Вероятность | ЦБ1 | ЦБ2 | Деп. |
|---|---:|---:|---:|---:|
| Благоприятная | 0.30 | 1.40 | 1.15 | 1.01 |
| Нейтральная  | 0.20 | 1.05 | 1.00 | 1.00 |
| Негативная   | 0.50 | 0.60 | 0.90 | 1.00 |

### Этап 3
| Ситуация | Вероятность | ЦБ1 | ЦБ2 | Деп. |
|---|---:|---:|---:|---:|
| Благоприятная | 0.40 | 1.15 | 1.12 | 1.05 |
| Нейтральная  | 0.40 | 1.05 | 1.01 | 1.01 |
| Негативная   | 0.20 | 0.70 | 0.94 | 1.00 |

---

## 2. Общая математическая формулировка задачи динамического программирования

Пусть состояние на шаге *t* описывается вектором

`S_t = (x1, x2, x3, c)` — текущие стоимости ЦБ1, ЦБ2, Деп. и свободных средств.

Управление — вектор целых изменений пакетов:

`u_t = (k1, k2, k3)` , где `k_i` — число пакетов на покупку (со знаком) для инструмента *i*.

Ограничения:
- `x_i + k_i * p_i >= 0` (нельзя продать больше, чем есть),
- `c - k1*p1 - k2*p2 - k3*p3 >= 0` (нет кредита).

Переход состояния по сценарию `ω`:

`x_i' = x_i * m_{t,i}(ω)`, `c' = c`.

Целевая функция (критерий Байеса):

`max E[ x1_3 + x2_3 + x3_3 + c_3 ]`.

---

## 3. Рекуррентное соотношение Беллмана

Обозначим `V_t(S_t)` — максимальное ожидаемое богатство, начиная с этапа *t*.

**Общий вид:**

`V_t(S) = max_{u ∈ U(S)}  E_ω [ V_{t+1}(F(S,u,ω)) ]`

`V_{T+1}(S) = x1 + x2 + x3 + c`.

**Обратный проход:** вычисление `V_t` от `t=3` к `t=1`.

**Прямой проход:** восстановление оптимальной стратегии, подставляя найденные управления.

---

## 4. Обозначения, постановка и рекуррентное соотношение для конкретной задачи

**Состояние:** `(x1, x2, x3, c)` — стоимость активов и свободных средств перед этапом.

**Управление:** `k1, k2, k3 ∈ Z` — число пакетов покупки/продажи (ЦБ1, ЦБ2, Деп.).

**Ограничения:**
- `x1 + 25*k1 >= 0`, `x2 + 200*k2 >= 0`, `x3 + 100*k3 >= 0`,
- `c - 25*k1 - 200*k2 - 100*k3 >= 0`.

**Переход:** по каждому сценарию множители из таблиц.

**Рекуррентное соотношение для задачи:**

`V_t(x1, x2, x3, c) = max_{k1,k2,k3}  sum_s p_s * V_{t+1}(x1*m1_s, x2*m2_s, x3*m3_s, c)`

`V_4(x1, x2, x3, c) = x1 + x2 + x3 + c`

---

## 5. Псевдокод основного алгоритма

```text
V_{T+1}(S) = x1 + x2 + x3 + c
for t = T ... 1:
  for each reachable state S:
    V_t(S) = -∞
    for each допустимое управление u:
      exp = 0
      for each сценарий ω:
         S' = F(S, u, ω)
         exp += P(ω) * V_{t+1}(S')
      if exp > V_t(S):
         V_t(S) = exp
         store argmax u
```

---

### Реализация

- Файл: `solution.py`
- Данные читаются из `Данные для постановки задачи.xlsx` (openpyxl).
- Реализовано динамическое программирование с критериями Байеса, учётом комиссий и минимальных остатков.
- Для последнего этапа используется жадный выбор по ожидаемой доходности (линейная цель).
- Для ускорения применена дискретизация:
  - активы представлены **в пакетах**;
  - свободные средства округляются до **200 д.е.** (`CASH_ROUND`).
  Это уменьшает число состояний и даёт устойчивый приближённый результат.

### Допущения и дискретизация

- После умножения на коэффициенты стоимость активов округляется до ближайшего числа пакетов.
- Комиссия учитывается при покупке/продаже пакета.
- Свободные средства округляются до 200 д.е., чтобы сократить число состояний.

---

## 6. Диаграмма классов программы (упрощённо)

```text
------------------+      +------------------+
|   Scenario      |      |     Action       |
| prob: double    |      | d1, d2, d3: int  |
| m1, m2, m3: int |      +------------------+
------------------+
         |
         v
------------------+      +------------------+
|     State        |      |     Result       |
| stage: int       |      | value: double    |
| h1,h2,h3,cash:int|      | action: Action   |
------------------+      +------------------+
```

---

## 7. Демонстрационные примеры программы

### Результаты (критерий Байеса, дискретизация пакетов)

Нумерация сценариев: 1 — благоприятный, 2 — нейтральный, 3 — негативный.

Результаты являются приближёнными из‑за дискретизации по пакетам и округления свободных средств.

**Начальный капитал:** **1900 д.е.** (100 + 800 + 400 + 600).

**Максимальное ожидаемое богатство:** **≈ 2332 д.е.**

**Ожидаемая прибыль:** **≈ 432 д.е.**

**Оптимальное управление перед этапом 1:**
- купить ЦБ1: 15 пак.
- купить ЦБ2: 1 пак.
- продать Деп.: 3 пак.

**Управления перед этапом 2 (по сценарию этапа 1):**

- Сценарий 1 (благоприятный):
  - продать ЦБ1: 18 пак., продать ЦБ2: 2 пак., купить Деп.: 1 пак.

- Сценарий 2 (нейтральный):
  - продать ЦБ1: 17 пак., продать ЦБ2: 1 пак., купить Деп.: 3 пак.

- Сценарий 3 (негативный):
  - продать ЦБ1: 13 пак., продать ЦБ2: 1 пак., купить Деп.: 2 пак.

**Управления перед этапом 3 (по сценариям этапа 2):**

- Для ветки 1.*:
  - купить Деп.: 12 пак.

- Для ветки 2.*:
  - купить Деп.: 8 пак.

- Для ветки 3.*:
  - купить Деп.: 8 пак.

---

### Пример запуска

Команды:

```bash
python3 -m pip install openpyxl
python3 solution.py
```

Пример вывода:

```text
Expected final wealth (Bayes): 2332
Stage 1 action: ЦБ1: купить 15 пак., ЦБ2: купить 1 пак., Деп.: продать 3 пак.
Stage 2 action (scenario 1): ЦБ1: продать 18 пак., ЦБ2: продать 2 пак., Деп.: купить 1 пак.
  Stage 3 action (scenario 1.1): Деп.: купить 12 пак.
  Stage 3 action (scenario 1.2): Деп.: купить 12 пак.
  Stage 3 action (scenario 1.3): Деп.: купить 12 пак.
Stage 2 action (scenario 2): ЦБ1: продать 17 пак., ЦБ2: продать 1 пак., Деп.: купить 3 пак.
  Stage 3 action (scenario 2.1): Деп.: купить 8 пак.
  Stage 3 action (scenario 2.2): Деп.: купить 8 пак.
  Stage 3 action (scenario 2.3): Деп.: купить 8 пак.
Stage 2 action (scenario 3): ЦБ1: продать 13 пак., ЦБ2: продать 1 пак., Деп.: купить 2 пак.
  Stage 3 action (scenario 3.1): Деп.: купить 8 пак.
  Stage 3 action (scenario 3.2): Деп.: купить 8 пак.
  Stage 3 action (scenario 3.3): Деп.: купить 8 пак.
```

---

## 8. Заключение

Была сформулирована и решена задача пошагового управления инвестиционным портфелем с использованием динамического программирования и критерия Байеса. Реализация читает входные данные из Excel, учитывает комиссии брокеров и минимальные остатки. Для практической вычислимости введена дискретизация по пакетам и округление свободных средств, что дало устойчивые приближённые результаты и позволило восстановить оптимальные управления на всех этапах.
